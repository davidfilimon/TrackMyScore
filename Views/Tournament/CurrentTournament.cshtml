@model TournamentModel

<div>
    <h1>@Model.Tournament.Name</h1>
    <p>@Model.Tournament.Reward, @Model.Tournament.Game.Title, @Model.Tournament.StartDate, @Model.Tournament.RoomCount, @Model.Tournament.MaxPlayers, @Model.Tournament.Code, @Model.Tournament.Type, @Model.Tournament.Host.Username, @Model.Tournament.Winner</p>
    <p>@Model.Tournament.Winner</p>
    <div>
        @if(Model.Tournament.Type == "single"){
            @foreach(var player in Model.Players)
            {
                <p>@player.User.Username</p>    
            }
        } else if (Model.Tournament.Type == "team" && Model.Teams != null) {

            @foreach(var team in Model.Teams)
            {
                <p>@team.Name</p>
                @foreach(var player in Model.Players)
                {
                    @if(player.Team.Id == team.Id){
                        <p>@player.User.Username</p>
                    }
                }
            }
        }
    </div>

    @if(Model.Players.Any(p => p.User.Id == Model.LoggedUser.Id)){
        <button class="btn btn-danger" onclick="leaveTournament(@Model.Tournament.Id)">Leave Tournament</button>
    } else {
        <button class="btn btn-dark" onclick="openJoinModal()">Join Tournament</button>
    }

    @if(@Model.LoggedUser == @Model.Tournament.Host){
        <button class="btn btn-dark" onclick="startTournament()">Start Tournament</button>
        <button class="btn btn-danger" onclick="deleteTournament()">Delete Tournament</button>
    }

    <div>
        @foreach(var room in Model.Rooms){
            <p>
                @room.Name
                <a class="btn btn-dark" asp-action="CurrentRoom" asp-controller="Room" asp-route-id="@room.Id">
                    View Details
                </a>
                @if(room.Stage == -1 && room.Mode == "single"){
                    <button class="btn btn-dark" onclick="startIndividualRoom(@room.Id)">Start Single Match</button>
                } else if(room.Stage == -1 && room.Mode == "team"){
                    <button class="btn btn-dark" onclick="startTeamRoom(@room.Id)">Start Team Match</button>
                } else if(room.Stage == 0){
                    <button class="btn btn-danger" onclick="endRoom(@room.Id)">End Match</button>
                }
            </p>
        }
    </div>
</div>

<div class="modal fade" id="joinModal" tabindex="-1" aria-labelledby="joinModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="joinModalLabel">Join Tournament</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            @if(Model.Tournament.Type == "single"){
                <div class="modal-body">
                    <form id="joinFormSingle" onsubmit="joinTournamentSingle(@Model.Tournament.Id, $('#code').val());">
                        <div class="mb-3">
                            <label for="code" class="form-label">Tournament Code</label>
                            <input type="text" class="form-control" id="code" name="code" required autocomplete="off">
                        </div>
                        <button type="submit" class="btn btn-primary">Join</button>
                    </form>
                </div>
            }
            @if(Model.Tournament.Type == "team"){
                <div class="modal-body">
                    <form id="joinFormTeam" onsubmit="joinTournamentTeam(@Model.Tournament.Id, $('#code').val(), $('#teammates').val(), $('#teamName').val());">
                        <div class="mb-3">
                            <label for="code" class="form-label">Tournament Code</label>
                            <input type="text" class="form-control" id="code" name="code" required autocomplete="off">
                        </div>
                        <div class="mb-3">
                            <label for="teamName" class="form-label">Team Name</label>
                            <input type="text" class="form-control" id="teamName" name="teamName" required autocomplete="off">
                        </div>
                        <div class="mb-3">
                            <label for="teammates" class="form-label">Teammates</label>
                            <select class="form-select" id="teammates" name="teammates" multiple required>
                                @foreach(var user in Model.MutualFollowers){
                                    <option value="@user.Id">@user.Username</option>
                                }
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Create Team</button>
                    </form>
                </div>
            }
        </div>
    </div>
</div>

<h1>Tournament Bracket</h1>
<!--<div class="bracket">
  <section aria-labelledby="round-1">
    <h2 id="round-1">Round 1</h2>
    <ol>
      <li>
        <div>
          <span>Player 1</span>
          <span>Player 2</span>
          <span>Date: 01.01. 1pm</span>
          </div>
      </li>
      <li>
        <div>
          <span>Player 3</span>
          <span>Player 4</span>
          <span>Date: 01.01. 1.30pm</span>
        </div>
      </li>
      <li>
        <div>
          <span>Player 5</span>
          <span>Player 6</span>
          <span>Date: 01.01. 2pm</span>
        </div>
      </li>
      <li>
        <div>
          <span>Player 7</span>
          <span>Player 8</span>
          <span>Date: 01.01. 2.30pm</span>
        </div>
      </li>
      <li>
        <div>
          <span>Player 9</span>
          <span>Player 10</span>
          <span>Date: 01.01. 3pm</span>
        </div>
      </li>
      <li>
        <div>
          <span>Player 11</span>
          <span>Player 12</span>
          <span>Date: 01.01. 3.30pm</span>
        </div>
      </li>
      <li>
        <div>
          <span>Player 13</span>
          <span>Player 14</span>
          <span>Date: 01.01. 4pm</span>
        </div>
      </li>
      <li>
        <div>
          <span>Player 15</span>
          <span>Player 16</span>
          <span>Date: 01.01. 4.30pm</span>
        </div>
      </li>
    </ol>
  </section>
  <section aria-labelledby="round-2">
    <h2 id="round-2">Round 2</h2>
      <ol>
        <li>
          <div>
            <span>Player 1</span>
            <span>Player 3</span>
            <span>Date: 05.01. 1pm</span>
          </div>
        </li>
        <li>
          <div>
            <span>Player 5</span>
            <span>Player 7</span>
            <span>Date: 05.01. 1.30pm</span>
          </div>
        </li>
        <li>
          <div>
            <span>Player 9</span>
            <span>Player 11</span>
            <span>Date: 05.01. 2pm</span>
          </div>
        </li>
        <li>
          <div>
            <span>Player 13</span>
            <span>Player 15</span>
            <span>Date: 05.01. 2.30pm</span>
          </div>
        </li>
      </ol>
  </section>
  <section aria-labelledby="round-3">
    <h2 id="round-3">Round 3</h2>
    <ol>
      <li>
        <div>
          <span>Player 1</span>
          <span>Player 5</span>
          <span>Date: 07.01. 1pm</span>
        </div>
      </li>
      <li>
        <div>
          <span>Player 9</span>
          <span>Player 13</span>
          <span>Date: 07.01. 1.30pm</span>
        </div>
      </li>
    </ol>
  </section>
  <section aria-labelledby="round-4">
    <h2 id="round-4">Round 4</h2>
    <ol>
      <li>
        <div>
          <span>Player 1</span>
          <span>Player 9</span>
          <span>Date: 10.01. 1pm</span>
        </div>
      </li>
    </ol>
  </section>
  <section aria-labelledby="winner">
    <h2 id="winner">Winner</h2>
    <ol>
      <li>
        <div>
          <span>Player 1</span>
        </div>
      </li>
    </ol>
  </section>
</div>-->

<div class="bracket br-2">
  <section aria-labelledby="round-1">
    <h2 id="round-1">Round 1</h2>
    <ol>
      <li>
          <a href="#">Player 1</a>
          <a href="#">Player 2</a>
          <span>Date: 01.01. 1pm</a>

      </li>
      <li>
        <div>
          <a href="#">Player 3</a>
          <a href="#">Player 4</a>
          <span>Date: 01.01. 1.30pm</span>
        </div>
      </li>
      <li>
        <div>
          <a href="#">Player 5</a>
          <a href="#">Player 6</a>
          <span>Date: 01.01. 2pm</s>
        </div>
      </li>
      <li>
        <div>
          <a href="#">Player 7</a>
          <a href="#">Player 8</a>
          <span>Date: 01.01. 2.30pm</span>
        </div>
      </li>
      <li>
        <div>
          <a href="#">Player 9</a>
          <a href="#">Player 10</a>
          <span>Date: 01.01. 3pm</span>
        </div>
      </li>
      <li>
        <div>
          <a href="#">Player 11</a>
          <a href="#">Player 12</a>
          <span>Date: 01.01. 3.30pm</span>
        </div>
      </li>
      <li>
        <div>
          <a href="#">Player 13</a>
          <a href="#">Player 14</a>
          <span>Date: 01.01. 4pm</span>
        </div>
      </li>
      <li>
        <div>
          <a href="#">Player 15</a>
          <a href="#">Player 16</a>
          <span>Date: 01.01. 4.30pm</span>
        </div>
      </li>
    </ol>
  </section>
  <section aria-labelledby="round-2">
    <h2 id="round-2">Round 2</h2>
      <ol>
        <li>
          <div>
            <a href="#">Player 1</a>
            <a href="#">Player 3</a>
            <span>Date: 05.01. 1pm</span>
          </div>
        </li>
        <li>
          <div>
            <a href="#">Player 5</a>
            <a href="#">Player 7</a>
            <span>Date: 05.01. 1.30pm</span>
          </div>
        </li>
        <li>
          <div>
            <a href="#">Player 9</a>
            <a href="#">Player 11</a>
            <span>Date: 05.01. 2pm</span>
          </div>
        </li>
        <li>
          <div>
            <a href="#">Player 13</a>
            <a href="#">Player 15</a>
            <span>Date: 05.01. 2.30pm</span>
          </div>
        </li>
      </ol>
  </section>
  <section aria-labelledby="round-3">
    <h2 id="round-3">Round 3</h2>
    <ol>
      <li>
        <div>
          <a href="#">Player 1</a>
          <a href="#">Player 5</a>
          <span>Date: 07.01. 1pm</span>
        </div>
      </li>
      <li>
        <div>
          <a href="#">Player 9</a>
          <a href="#">Player 13</a>
          <span>Date: 07.01. 1.30pm</span>
        </div>
      </li>
    </ol>
  </section>
  <section aria-labelledby="round-4">
    <h2 id="round-4">Round 4</h2>
    <ol>
      <li>
        <div>
          <a href="#">Player 1</a>
          <a href="#">Player 9</a>
          <span>Date: 10.01. 1pm</span>
        </div>
      </li>
    </ol>
  </section>
  <section aria-labelledby="winner">
    <h2 id="winner">Winner</h2>
    <ol>
      <li>
        <div>
          <a href="#">Player 1</a>
        </div>
      </li>
    </ol>
  </section>
</div>
<script>
    function startTournament() {
        $.ajax({
            url: '/Tournament/Start',
            type: 'POST',
            data: {
                id: @Model.Tournament.Id
            },
            success: function (data) {
                if (data.success) {
                    alert('Tournament started successfully!');
                    location.reload();
                } else {
                    alert('Failed to start tournament: ' + data.message);
                }
            },
            error: function (xhr, status, error) {
                console.error('Error starting tournament:', error);
            }
        });
    }

    function deleteTournament() {
        $.ajax({
            url: '/Tournament/Delete',
            type: 'POST',
            data: { id: @Model.Tournament.Id },
            success: function (data) {
                if (data.success) {
                    alert('Tournament deleted successfully!');
                    window.location.href = '/';
                } else {
                    alert('Failed to delete tournament: ' + data.message);
                }
            },
            error: function (xhr, status, error) {
                console.error('Error deleting tournament:', error);
            }
        });
    }

    function openJoinModal() {
        $('#joinModal').modal('show');
    }

    function joinTournamentSingle(id, code){
        $.ajax({
            url: '/Tournament/JoinSingle',
            type: 'POST',
            data: {
                id: id,
                code: code
            },
            success: function(data){
                if(data.success){
                    alert(data.message);
                    location.reload();
                } else {
                    alert(data.message);
                }
            },
            error: function(xhr, status, error){
                console.error('Error joining tournament:', error);
            }
        })
    }

    function joinTournamentTeam(id, code, teammates, teamName){
        $.ajax({
            url: '/Tournament/JoinTeam',
            type: 'POST',
            data: {
                id: id,
                code: code,
                teammates: teammates,
                teamName: teamName
            },
            success: function(data){
                if(data.success){
                    alert(data.message);
                    location.reload();
                } else {
                    alert(data.message);
                }
            },
            error: function(xhr, status, error){
                console.error('Error joining tournament:', error);
            }
        })
    }

    function leaveTournament(id){
        $.ajax({
            url: '/Tournament/Leave',
            type: 'POST',
            data: {
                 id: id
            },
            success: function(data){
                if(data.success){
                    alert(data.message);
                    window.location.href = '/Tournament/CurrentTournament/' + id;
                } else {
                    alert(data.message);
                }
            },
            error: function(xhr, status, error){
                console.error('Error leaving tournament:', error);
            }
        })
    }

    function startIndividualRoom(roomId){
        $.ajax({
            url: "Room/StartIndividual",
            type: "POST",
            data: {
                roomId : roomId
            },
            success: function(data){
                if(data.success){
                    alert(data.message);
                    location.reload();
                } else {
                    alert(data.message);
                }
            },
            error: function(xhr, status, error){
                console.error('Error starting room:', error);
            }
        })
    }
    
    function endRoom(roomId){
        $.ajax({
            url: "Tournament/EndBracket",
            type: "POST",
            data: {
                roomId : roomId
            },
            success: function(data){
                if(data.success){
                    alert(data.message);
                    location.reload();
                } else {
                    alert(data.message);
                }
            },
            error: function(xhr, status, error){
                console.error('Error ending room:', error);
            }
        })
    }

</script>

<style>
    :root {
  --border: 1px solid black;
}

.bracket {
  display: flex;
  justify-content: space-between;
  margin-bottom: 100px;
  overflow: visible;
  width: 100%;
}

section {
  max-width: 200px;
  min-width: 100px;
  padding: 0 20px 0 10px;
  width: 17%;
}

ol {
  display: flex;
  flex-flow: row wrap;
  /*list-style-type: "";*/
  margin: 0;
  min-height: 100%;
  padding: 0;
}

li {
  display: flex;
  flex-direction: column;
  justify-content: center;
  margin: 20px 0;
  position: relative;
  width: 100%;
}

div:not(.bracket) {
    border: var(--border);
}

a, span {
  display: block;
}

section:not(:nth-child(4), :last-child) {
  & li:after, li:before {
    content: "";
    display: block;
    position: absolute;
  }

  & li:after {
    right: -16px;
    width: 15px;
  }

  & li
</style>